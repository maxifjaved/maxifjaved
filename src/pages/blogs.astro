---
import BlogPost from "../components/BlogPost.astro";
import MainLayout from "../layouts/MainLayout.astro";
import { getCollection } from 'astro:content';

// Get all blog posts
const allPosts = await getCollection('blog', ({ data }) => {
  return data.draft !== true;
});

// Sort posts by date (newest first)
const sortedPosts = allPosts.sort((a, b) => 
  new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
);

// Search and category filtering
const searchQuery = Astro.url.searchParams.get('search') || '';
const selectedCategory = Astro.url.searchParams.get('category');

let filteredPosts = sortedPosts;

// Apply search filter
if (searchQuery) {
  filteredPosts = filteredPosts.filter(post => 
    post.data.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
    post.data.subtitle.toLowerCase().includes(searchQuery.toLowerCase()) ||
    post.data.category.toLowerCase().includes(searchQuery.toLowerCase())
  );
}

// Apply category filter
if (selectedCategory) {
  filteredPosts = filteredPosts.filter(post => 
    post.data.category.toLowerCase() === selectedCategory.toLowerCase()
  );
}

// Pagination settings (after filtering)
const POSTS_PER_PAGE = 6;
const currentPage = parseInt(Astro.url.searchParams.get('page') || '1');
const totalPages = Math.ceil(filteredPosts.length / POSTS_PER_PAGE);
const startIndex = (currentPage - 1) * POSTS_PER_PAGE;
const endIndex = startIndex + POSTS_PER_PAGE;
const paginatedPosts = filteredPosts.slice(startIndex, endIndex);

// Get unique categories for filter
const categories = [...new Set(allPosts.map(post => post.data.category))];
---

<MainLayout
  title="Blog - Muhammad Asif Javed"
  description="Latest articles on WebRTC, real-time systems, cybersecurity, and enterprise development by Muhammad Asif Javed"
>
    <BlogPost posts={paginatedPosts} currentPage={currentPage} totalPages={totalPages} categories={categories} selectedCategory={selectedCategory} searchQuery={searchQuery} />
    <div class="pt-16"></div>
</MainLayout>
